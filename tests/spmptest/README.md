# SPMPtest

专门为sPMP实现定制的测试程序，通过触发sPMP异常来测试sPMP逻辑是否完善

新异常号:
- 16: sPMP Instr Fault
- 17: sPMP Load Fault
- 18: sPMP Store Fault

## 编译

```bash
make ARCH=$(ARCH)
```

## SPMPtest流程

1. 调用`_cte_init`，初始化必要寄存器，最后切换到S模式
2. 调用`init_spmp_handler`，初始化sPMP异常处理函数和ecall处理函数（在M模式处理异常）
3. 通过`ecall`切换到M模式（此处切换是为了避免一些限制）
4. 通过`s2m`切换到M模式，然后进入到测试主逻辑`test_entry`中
5. `test_entry`通过`flag`依次进入到不同测试中，当前分别是
    - 在`mode=U, sum=(0/1)`情况下测试
    - 在`mode=S, sum=0`情况下测试
    - 在`mode=S, sum=1`情况下测试
6. 首先在`spmp_test_init_modeX`函数中初始化sPMP寄存器等信息
7. 之后通过`MRET`宏，以U或S权限跳到对应测试程序中
8. 测试完成后，通过`ecall`再次回到`test_entry`中，也就是第5步

## 测试内容

当前的测试逻辑是：

首先用一个`init`函数，初始化sPMP寄存器，之后用`mret`调用特定测试程序进行测试

例：
> sPMP U模式下测试，首先用`spmp_test_init_modeU`初始化sPMP寄存器，然后调用`spmp_test_modeU`进行测试
> 然后需要一个对照数组`modeU_priv`，sPMP测试时会将测试结果写进`test_priv`数组，
> 最后对比这两个数组就可以得到结果是否正确

数组结果位置是通过sPMP地址寄存器相对TEST_BASE来的，
以下为sPMP配置寄存器与地址寄存器配置情况

### U模式下测试时16个sPMP寄存器配置情况

| index | sPMP寄存器序号 | 起始地址   | 大小        | srwx | 对照权限结果(0xwr) |
| ----- | -------------- | ---------- | ----------- | ---- | ------------------ |
| 0     | 0              | 0x80010000 | 0x1000      | 0    | 0                  |
| 1     | 1              | 0x80011000 | 0x1000      | 1    | 4                  |
| 2     | 2              | 0x80012000 | 0x1000      | 2    | 1                  |
| 3     | 3              | 0x80013000 | 0x1000      | 3    | 3                  |
| 4     | 4              | 0x80014000 | 0x1000      | 4    | 1                  |
| 5     | 5              | 0x80015000 | 0x1000      | 5    | 5                  |
| 6     | 6              | 0x80016000 | 0x1000      | 6    | 3                  |
| 7     | 7              | 0x80017000 | 0x1000      | 15   | 1                  |
| 8     | 8              | 0x80018000 | 0x1000      | 8    | 0                  |
| 9     | 9              | 0x80019000 | 0x1000      | 9    | 0                  |
| 10    | 10             | 0x8001a000 | 0x1000      | 10   | 4                  |
| 11    | 11             | 0x8001b000 | 0x1000      | 11   | 4                  |
| 12    | 12             | 0x8001c000 | 0x1000      | 12   | 0                  |
| 13    | 13             | 0x8001d000 | 0x1000      | 13   | 0                  |
| 14    | 14             | 0x8001e000 | 0x1000      | 14   | 0                  |
| 15    | 15             | 0x0        | 0x100000000 | 7    | 7                  |

### S模式下测试时16个sPMP寄存器配置情况

| index | sPMP序号 | 起始地址   | 大小   | srwx | 对照结果sum=0(0xwr) | 对照结果sum=1(0xwr) |
| ----- | -------- | ---------- | ------ | ---- | ------------------- | ------------------- |
| 0     | 0        | 0x80010000 | 0x1000 | 0    | 0                   | 0                   |
| 1     | 1        | 0x80011000 | 0x1000 | 1    | 0                   | 0                   |
| 2     | 2        | 0x80012000 | 0x1000 | 2    | 3                   | 3                   |
| 3     | 3        | 0x80013000 | 0x1000 | 3    | 3                   | 3                   |
| 4     | 4        | 0x80014000 | 0x1000 | 4    | 0                   | 1                   |
| 5     | 5        | 0x80015000 | 0x1000 | 5    | 0                   | 1                   |
| 6     | 6        | 0x80016000 | 0x1000 | 6    | 0                   | 3                   |
| 7     | 7        | 0x80017000 | 0x1000 | 7    | 0                   | 3                   |
| 8     | 8        | 0x80018000 | 0x1000 | 8    | 0                   | 0                   |
| 9     | 9        | 0x80019000 | 0x1000 | 9    | 4                   | 4                   |
| 10    | 10       | 0x8001a000 | 0x1000 | 10   | 4                   | 4                   |
| 11    | 11       | 0x8001b000 | 0x1000 | 11   | 5                   | 5                   |
| 12    | 12       | 0x8001c000 | 0x1000 | 12   | 1                   | 1                   |
| 13    | 13       | 0x8001d000 | 0x1000 | 13   | 5                   | 5                   |
| 14    | 14       | 0x8001e000 | 0x1000 | 14   | 3                   | 3                   |
| 15    | 15       | 0x8001f000 | 0x1000 | 15   | 1                   | 1                   |
